name: CI/CD Pipeline

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '23'

    - name: Verify Node.js and npm installation
      run: |
        echo "Checking if Node.js is installed..."
        if ! command -v node &> /dev/null; then
          echo "Error: Node.js is not installed on this self-hosted runner."
          exit 1
        else
          echo "Node.js is available: $(node --version)"
        fi

        echo "Checking if npm is installed..."
        if ! command -v npm &> /dev/null; then
          echo "Error: npm is not installed on this self-hosted runner."
          echo "Please install Node.js with npm on your runner."
          exit 1
        else
          echo "npm is available: $(npm --version)"
        fi

    - name: Check for jq
      run: |
        if ! command -v jq &> /dev/null; then
          echo "Error: jq is not installed on this self-hosted runner."
          echo "Please install jq on your runner: sudo apt-get install jq"
          exit 1
        else
          echo "jq is available: $(jq --version)"
        fi

    - name: Set project list
      run: |
        echo "PROJECTS=(backend-service auth-service frontend migration-service)" >> $GITHUB_ENV

    - name: Ensure proper permissions for node_modules cleanup
      run: |
        # Create a script to ensure proper cleanup of node_modules
        cat > cleanup-node-modules.sh << 'EOF'
        #!/bin/bash
        for dir in ${PROJECTS[@]}; do
          if [ -d "$dir/node_modules" ]; then
            echo "Setting permissions for $dir/node_modules"
            sudo chown -R $(whoami):$(whoami) "$dir/node_modules" 2>/dev/null || true
            chmod -R 755 "$dir/node_modules" 2>/dev/null || true
          fi
        done
        EOF
        chmod +x cleanup-node-modules.sh

    - name: Install dependencies
      run: |
        for dir in ${PROJECTS[@]}; do
          if [ -d "$dir" ] && [ -f "$dir/package.json" ]; then
            echo "Installing deps for $dir"
            if [ -f "$dir/package-lock.json" ]; then
              npm ci --prefix "$dir"
            else
              npm install --prefix "$dir"
            fi
          fi
        done

    - name: Post-installation permission fix
      run: |
        # Fix permissions after installation to prevent cleanup issues
        for dir in ${PROJECTS[@]}; do
          if [ -d "$dir/node_modules" ]; then
            echo "Fixing permissions for $dir/node_modules"
            find "$dir/node_modules" -type d -exec chmod 755 {} \; 2>/dev/null || true
            find "$dir/node_modules" -type f -exec chmod 644 {} \; 2>/dev/null || true

            # Ensure executable permissions for files in .bin directory
            if [ -d "$dir/node_modules/.bin" ]; then
              echo "Setting executable permissions for $dir/node_modules/.bin"
              chmod -R 755 "$dir/node_modules/.bin" 2>/dev/null || true
              # Additionally, explicitly set executable permissions for all files
              find "$dir/node_modules/.bin" -type f -exec chmod 755 {} \; 2>/dev/null || true
            fi
          fi
        done

    - name: Ensure executable permissions before running scripts
      run: |
        for dir in ${PROJECTS[@]}; do
          if [ -d "$dir/node_modules/.bin" ]; then
            echo "Ensuring executable permissions in $dir/node_modules/.bin"
            chmod -R 755 "$dir/node_modules/.bin" 2>/dev/null || true
            # Additionally, explicitly set executable permissions for all files
            find "$dir/node_modules/.bin" -type f -exec chmod 755 {} \; 2>/dev/null || true
          fi
        done

    - name: Run linting
      run: |
        for dir in ${PROJECTS[@]}; do
          if [ -f "$dir/package.json" ]; then
            npm run lint --prefix "$dir"
          fi
        done

    - name: Ensure executable permissions before running tests
      run: |
        for dir in ${PROJECTS[@]}; do
          if [ -d "$dir/node_modules/.bin" ]; then
            echo "Ensuring executable permissions in $dir/node_modules/.bin before tests"
            chmod -R 755 "$dir/node_modules/.bin" 2>/dev/null || true
            # Additionally, explicitly set executable permissions for all files
            find "$dir/node_modules/.bin" -type f -exec chmod 755 {} \; 2>/dev/null || true
          fi
        done

    - name: Run tests
      run: |
        for dir in ${PROJECTS[@]}; do
          if [ -f "$dir/package.json" ]; then
            # Check if test script exists in package.json
            TEST_SCRIPT=$(jq -r '.scripts.test' "$dir/package.json" 2>/dev/null)
            if [ "$TEST_SCRIPT" != "null" ] && [ -n "$TEST_SCRIPT" ]; then
              echo "Running tests for $dir"
              npm run test --prefix "$dir"
            else
              echo "No test script found in $dir/package.json, skipping tests"
            fi
          fi
        done
    - name: Build Docker images
      run: |
        docker-compose -f docker-compose.test.yml build
        
    - name: Run integration tests
      run: |
        docker-compose -f docker-compose.test.yml up --build --abort-on-container-exit --exit-code-from tests

    - name: Cleanup node_modules to prevent permission issues
      if: always()  # This runs even if previous steps fail
      run: |
        for dir in ${PROJECTS[@]}; do
          if [ -d "$dir/node_modules" ]; then
            echo "Cleaning up $dir/node_modules"
            chmod -R 755 "$dir/node_modules" 2>/dev/null || true
            rm -rf "$dir/node_modules" 2>/dev/null || echo "Some files in $dir/node_modules could not be removed, which is OK"
          fi
        done

  build-and-push:
    needs: test
    runs-on: self-hosted
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Build and push frontend
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        push: true
        tags: ghcr.io/${{ github.repository }}/frontend:latest,ghcr.io/${{ github.repository }}/frontend:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Build and push backend
      uses: docker/build-push-action@v5
      with:
        context: ./backend-service
        push: true
        tags: ghcr.io/${{ github.repository }}/backend:latest,ghcr.io/${{ github.repository }}/backend:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Build and push auth-service
      uses: docker/build-push-action@v5
      with:
        context: ./auth-service
        push: true
        tags: ghcr.io/${{ github.repository }}/auth:latest,ghcr.io/${{ github.repository }}/auth:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy:
    needs: build-and-push
    runs-on: self-hosted
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to production
      env:
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      run: |
        # Create deployment script
        cat > deploy.sh << 'EOF'
        #!/bin/bash
        set -e
        
        # Stop existing containers
        docker-compose -f docker-compose.prod.yml down || true
        
        # Pull latest images
        docker-compose -f docker-compose.prod.yml pull
        
        # Start services
        docker-compose -f docker-compose.prod.yml up -d
        
        # Wait for services to be healthy
        sleep 30
        
        # Check if services are running properly
        if docker-compose -f docker-compose.prod.yml ps | grep -q "Up"; then
          echo "Deployment successful!"
        else
          echo "Deployment failed!"
          exit 1
        fi
        EOF
        
        # Make deploy script executable
        chmod +x deploy.sh
