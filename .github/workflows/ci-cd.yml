name: CI/CD Pipeline

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '23'

    - name: Verify Node.js and npm installation
      run: |
        echo "Checking if Node.js is installed..."
        if ! command -v node &> /dev/null; then
          echo "Error: Node.js is not installed on this self-hosted runner."
          exit 1
        else
          echo "Node.js is available: $(node --version)"
        fi

        echo "Checking if npm is installed..."
        if ! command -v npm &> /dev/null; then
          echo "Error: npm is not installed on this self-hosted runner."
          echo "Please install Node.js with npm on your runner."
          exit 1
        else
          echo "npm is available: $(npm --version)"
        fi

    - name: Check for jq
      run: |
        if ! command -v jq &> /dev/null; then
          echo "Error: jq is not installed on this self-hosted runner."
          echo "Please install jq on your runner: sudo apt-get install jq"
          exit 1
        else
          echo "jq is available: $(jq --version)"
        fi

    - name: Set project list
      run: |
        echo "PROJECTS=(backend-service auth-service frontend migration-service)" >> $GITHUB_ENV

    - name: Clean node_modules before installation
      run: |
        for dir in ${PROJECTS[@]}; do
          if [ -d "$dir/node_modules" ]; then
            echo "Cleaning node_modules for $dir"
            rm -rf "$dir/node_modules"
          fi
        done

    - name: Install dependencies
      run: |
        for dir in ${PROJECTS[@]}; do
          if [ -d "$dir" ] && [ -f "$dir/package.json" ]; then
            echo "Installing deps for $dir"
            if [ -f "$dir/package-lock.json" ]; then
              npm ci --prefix "$dir"
            else
              npm install --prefix "$dir"
            fi
          fi
        done


    - name: Run linting
      run: |
        for dir in ${PROJECTS[@]}; do
          if [ -f "$dir/package.json" ]; then
            npm run lint --prefix "$dir"
          fi
        done

    - name: Run tests
      run: |
        for dir in ${PROJECTS[@]}; do
          if [ -f "$dir/package.json" ]; then
            # Check if test script exists in package.json
            TEST_SCRIPT=$(jq -r '.scripts.test' "$dir/package.json" 2>/dev/null)
            if [ "$TEST_SCRIPT" != "null" ] && [ -n "$TEST_SCRIPT" ]; then
              echo "Running tests for $dir"
              npm run test --prefix "$dir"
            else
              echo "No test script found in $dir/package.json, skipping tests"
            fi
          fi
        done
    - name: Build Docker images
      run: |
        docker-compose -f docker-compose.test.yml build
        
    - name: Run integration tests
      run: |
        docker-compose -f docker-compose.test.yml up --build --abort-on-container-exit --exit-code-from tests



  build-and-push:
    needs: test
    runs-on: self-hosted
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Build and push frontend
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        push: true
        tags: ghcr.io/${{ github.repository }}/frontend:latest,ghcr.io/${{ github.repository }}/frontend:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Build and push backend
      uses: docker/build-push-action@v5
      with:
        context: ./backend-service
        push: true
        tags: ghcr.io/${{ github.repository }}/backend:latest,ghcr.io/${{ github.repository }}/backend:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Build and push auth-service
      uses: docker/build-push-action@v5
      with:
        context: ./auth-service
        push: true
        tags: ghcr.io/${{ github.repository }}/auth:latest,ghcr.io/${{ github.repository }}/auth:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy:
    needs: build-and-push
    runs-on: self-hosted
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to production
      env:
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      run: |
        # Create deployment script
        cat > deploy.sh << 'EOF'
        #!/bin/bash
        set -e
        
        # Stop existing containers
        docker-compose -f docker-compose.prod.yml down || true
        
        # Pull latest images
        docker-compose -f docker-compose.prod.yml pull
        
        # Start services
        docker-compose -f docker-compose.prod.yml up -d
        
        # Wait for services to be healthy
        sleep 30
        
        # Check if services are running properly
        if docker-compose -f docker-compose.prod.yml ps | grep -q "Up"; then
          echo "Deployment successful!"
        else
          echo "Deployment failed!"
          exit 1
        fi
        EOF
        
        # Make deploy script executable
        chmod +x deploy.sh
